# PostgreSQL Backup & Restore with S3 Integration

## üìå –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö **PostgreSQL** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –±—ç–∫–∞–ø–æ–≤ –≤ **Amazon S3** –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **GitLab CI/CD**.

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:

* –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –¥–∞–º–ø–æ–≤ PostgreSQL —Å –ø–æ–º–æ—â—å—é `pg_dump`
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é `pg_restore`
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π (—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ S3, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
* –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –≤ **S3** –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ **GitLab CI/CD**

---

## üõ† –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* **PostgreSQL client tools** (`pg_dump`, `pg_restore`)
* **AWS CLI** (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ S3)
* –î–æ—Å—Ç—É–ø –∫ PostgreSQL —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –±—ç–∫–∞–ø/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
* GitLab Runner (–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `.gitlab-ci.yml`)

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã

```bash
./backup.sh <PG_PASSWORD> <HOST> <PORT> <POSTGRESQL_USER> <DATABASE> [BACKDIR] [S3_BUCKET]
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

* `PG_PASSWORD` ‚Äì –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è PostgreSQL
* `HOST` ‚Äì —Ö–æ—Å—Ç PostgreSQL
* `PORT` ‚Äì –ø–æ—Ä—Ç PostgreSQL
* `POSTGRESQL_USER` ‚Äì –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* `DATABASE` ‚Äì –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
* `BACKDIR` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* ‚Äì –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/store/backup`)
* `S3_BUCKET` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* ‚Äì –∏–º—è S3 bucket –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏

**–ü—Ä–∏–º–µ—Ä:**

```bash
./backup.sh mypass db.example.com 5432 postgres mydb /store/backup my-s3-bucket
```

---

### 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã

```bash
./restore.sh <PG_PASSWORD> <HOST> <PORT> <POSTGRESQL_USER> <DATABASE> [BACKDIR]
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

* `PG_PASSWORD` ‚Äì –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è PostgreSQL
* `HOST` ‚Äì —Ö–æ—Å—Ç PostgreSQL
* `PORT` ‚Äì –ø–æ—Ä—Ç PostgreSQL
* `POSTGRESQL_USER` ‚Äì –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* `DATABASE` ‚Äì –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
* `BACKDIR` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* ‚Äì –ø–∞–ø–∫–∞ —Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/store/backup`)

**–ü—Ä–∏–º–µ—Ä:**

```bash
./restore.sh mypass db.example.com 5432 postgres mydb /store/backup/mydb_31.08.2025-1200
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Backup database on S3/
‚îÇ‚îÄ‚îÄ backup.sh        # –°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—ã–≥—Ä—É–∑–∫–∏ –Ω–∞ S3
‚îÇ‚îÄ‚îÄ restore.sh       # –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
‚îÇ‚îÄ‚îÄ gitlab-ci.yml    # CI/CD pipeline –¥–ª—è GitLab
```

---

## ‚ö° GitLab CI/CD

–í –ø—Ä–æ–µ–∫—Ç–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω `.gitlab-ci.yml` —Å —Ç—Ä–µ–º—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏ job‚Äô–∞–º–∏:

* **`backup_job`** ‚Äì –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤—ã–≥—Ä—É–∑–∫—É –Ω–∞ S3.
* **`restore_job`** ‚Äì –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫, `when: manual`).
* **`check_directory`** ‚Äì –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å –±—ç–∫–∞–ø–∞–º–∏.

üîë –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ GitLab CI:

* `SSH_USER`, `SSH_HOST`, `SSH_PRIVATE_KEY` ‚Äì –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É
* `PG_PASSWORD`, `HOST`, `PORT`, `POSTGRESQL_USER`, `DATABASE`, `BACKDIR`, `S3_BUCKET` ‚Äì –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–∞–∑—ã –∏ S3

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è GitLab (Pipeline Schedules)

–ß—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞—Ç—å –±—ç–∫–∞–ø –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 —É—Ç—Ä–∞:

1. –ó–∞–π–¥–∏—Ç–µ –≤ **CI/CD ‚Üí Schedules** –≤ GitLab.
2. –ù–∞–∂–º–∏—Ç–µ **New schedule**.
3. –£–∫–∞–∂–∏—Ç–µ cron-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ:

   ```
   0 3 * * *
   ```
4. –í–∫–ª—é—á–∏—Ç–µ `backup_job`.
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ.

---

## üìù –õ–æ–≥–∏

* –õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/store/logs/`
* –ü—Ä–∏–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤:

  * `pg_backup_<DB>_<DATE>.log` ‚Äì –ø—Ä–æ—Ü–µ—Å—Å –±—ç–∫–∞–ø–∞
  * `s3_upload_<DB>_<DATE>.log` ‚Äì –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3
  * `restore_<DB>_<DATE>.log` ‚Äì –ø—Ä–æ—Ü–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —á–∏—Å–ª–∞ —Ñ–∞–π–ª–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏ —É–¥–∞–ª—ë–Ω–Ω–æ–π –ø–∞–ø–∫–µ.